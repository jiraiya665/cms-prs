{"additions": 13, "auther_ref": "GeomDet-type-fixes", "auther_sha": "6c57594486c692d59d2249193cf5f344fce3e801", "author": "dan131riley", "body": "#### PR description:\r\n\r\nThe `BaseTrackerRecHit` constructor implicitly assumes that the `GeomDet` passed to it is a `TrackerGeomDet` by doing a `static_cast` to that type:\r\n\r\nhttps://github.com/cms-sw/cmssw/blob/30a2ff8ff13aaa416259453b54ad0b62588edc91/DataFormats/TrackerRecHit2D/interface/BaseTrackerRecHit.h#L29\r\n\r\nChanging the `static_cast` to `dynamic_cast` revealed that this assumption is violated by the `MTDTrackingRecHitProducer`, which passes an `MTDGeomDet` here:\r\n\r\nhttps://github.com/cms-sw/cmssw/blob/30a2ff8ff13aaa416259453b54ad0b62588edc91/RecoLocalFastTime/FTLRecProducers/plugins/MTDTrackingRecHitProducer.cc#L120\r\n\r\n`MTDGeomDet` does not inherit from `TrackerGeomDet`, but is instead a copy&paste copy of `TrackerGeomDet` that inherits directly from `GeomDet`:\r\n\r\nhttps://github.com/cms-sw/cmssw/blob/30a2ff8ff13aaa416259453b54ad0b62588edc91/Geometry/CommonDetUnit/interface/MTDGeomDet.h#L6\r\n\r\nThis doesn't crash and isn't caught by the address sanitizer because the class layout is the same, but it is still a bug that could eventually lead to failures if the different classes evolve separately.  Since `MTDGeomDet` currently has functionality identical to `TrackerGeomDet`, this PR makes `MTDGeomDet` a typedef for `TrackerGeomDet`.  If in the future additional functionality is needed in `MTDGeomDet` it can be made a class that inherits from `TrackerGeomDet`.  This resolves issue #28571.\r\n\r\nIn addition, this PR changes the static cast in `BaseTrackerRecHit` to a dynamic cast to reference type so that future issues will be found, along with similar changes to several other static casts that were not obviously safe on inspection.  It also removes some casts that are unnecessary since `GeomDet` and `GeomDetUnit` are now the same type, and makes a small change to `AlignmentPositionError` in `GeomDet` and  `TrackerGeomDet` to improve encapsulation and reduce code replication.\r\n\r\n#### PR validation:\r\n\r\nA limited matrix was run with no new failures observed.  This is strictly a technical fix that should have no effect on physics results.", "branch": "master", "changed_files": 9, "comments": 17, "commits": 3, "created_at": "1575925183", "deletions": 50, "labels": ["code-checks-approved", "comparison-pending", "geometry-pending", "orp-pending", "pending-signatures", "reconstruction-pending", "tests-started", "upgrade-pending"], "milestone": "CMSSW_11_1_X", "number": 28590, "release-notes": [], "review_comments": 11, "state": "open", "title": "Correct MTDGeomDet type problems", "updated_at": "1576083371", "user": "dan131riley"}